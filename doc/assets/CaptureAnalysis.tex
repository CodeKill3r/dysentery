\documentclass[11pt]{article}

\usepackage[english]{babel}
\usepackage{courier}
\usepackage{graphicx}
\usepackage[bottom]{footmisc}
\usepackage{bytefield}
\usepackage{hyperref}

\title{DJ Link Packet Analysis}
\author{James Elliott\\Deep Symmetry, LLC}

\begin{document}

\maketitle

\abstract{The protocol used by Pioneer professional DJ equipment to
  communicate and coordinate performances can be monitored to provide
  useful information for synchronizing other software, such as light
  shows and sequencers. By creating a ``virtual CDJ'' that sends
  appropriate packets to the network, other devices can be induced to
  send packets containing even more useful information about their
  state. This article documents what has been learned so far about the
  protocol, and how to accomplish these tasks.}

\section{Mixer Startup}

When the mixer starts up, after it obtains an IP address (or gives up
on doing that and self-assigns an address), it sends out what look
like a series of packets\footnote{The packet capture described in this
  analysis can be found at
  \url{https://github.com/brunchboy/dysentery/raw/master/doc/assets/powerup.pcapng}}
simply announcing its existence to UDP port 50000 on the broadcast
address of the local network.

\begin{figure}
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{0a}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 25} {\tt 02}} \\
  \end{bytefield}
  \caption{Initial announcement packets from Mixer}
  \label{fig:mixerInitial}
\end{figure}

These have a data length\footnote{Values within packets are shown in
  hexadecimal, while packet lengths and byte offsets are discussed in
  decimal.} of 37 bytes, appear roughly every 300 milliseconds, and
have the content shown in Figure \ref{fig:mixerInitial}.

The tenth byte (inside what is labeled the header) is bolded because
its value changes in the different types of packets which follow.

After about three of these packets are sent, another series of three
begins. It is not clear what purpose these packets serve, because they
are not yet asserting ownership of any device number; perhaps they are
used when CDJs are powering up as part of the mechanism the mixer can
use to tell them which device number to use based on which network
port they are connected to?

\begin{figure}
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{00}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 2c} {$N$} {\tt 02}} &
    \bitbox{6}{MAC address} \\
  \end{bytefield}
  \caption{First-stage Mixer device number assignment packets}
  \label{fig:mixerStage1}
\end{figure}

In any case, these three packets have a data length of 44 bytes, are
again sent to UDP port 50000 on the local network broadcast address,
at roughly 300 millisecond intervals, and have the content shown in
Figure \ref{fig:mixerStage1}.

The value $N$ at byte 36 is 1, 2, or 3, depending on whether this
is the first, second, or third time the packet is sent.

After these comes another series of three numbered packets. These
appear to be claiming the device number for a particular device, as
well as announcing the IP address at which it can be found. They have
a data length of 50 bytes, and are again sent to UDP port 50000 on the
local network broadcast address, at roughly 300 millisecond intervals,
with the content shown in Figure \ref{fig:mixerStage2}.

\begin{figure}[ht]
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{02}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 32}} &
    \bitbox{4}{IP address} & \bitbox{6}{MAC address} &
    \bitbox{1}{$D$} & \bitbox{1}{$N$} \\
    \bitboxes*{1}{{\tt 02} {\tt 01}} \\
  \end{bytefield}
  \caption{Second-stage Mixer device number assignment packets}
  \label{fig:mixerStage2}
\end{figure}

I identify these as claiming/identifying the device number because the
value $D$ at byte 46 is the same as the device number that the
mixer uses to identify itself ({\tt 0x21}) and the same is true for the
corresponding packets seen from the CDJs (they use device numbers 2
and 3, as they are connected to those ports/channels on the mixer).

As with the previous series of three packets, the value $N$ at
byte 47 takes on the values 1, 2, and 3 in the three packets.

These are followed by another three packets, perhaps the last stage of
claiming the device number, again at 300 millisecond intervals, to the
same port 50000. These shorter packets have 38 bytes of data and the
content shown in Figure \ref{fig:mixerStage3}.

\begin{figure}
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{04}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 26}} &
    \bitbox{1}{$D$} & \bitbox{1}{$N$} \\
  \end{bytefield}
  \caption{Final-stage Mixer device number assignment packets}
  \label{fig:mixerStage3}
\end{figure}

As before the value $D$ at byte 36 is the same as the device
number that the mixer uses to identify itself ({\tt 0x21}) and
$N$ at byte 37 takes on the values 1, 2, and 3 in the three
packets.

Once those are sent, the mixer seems to settle down and send what
looks like a keep-alive packet to retain presence on the network and
ownership of its device number, at a less frequent interval. These
packets are 54 bytes long, again sent to port 50000 on the local
network broadcast address, roughly every second and a half. They have
the content shown in Figure \ref{fig:mixerKeepalive}.

\begin{figure}[h]
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{06}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 36}} &
    \bitbox{1}{$D$} & \bitbox{1}{\tt 02} &
    \bitbox{6}{MAC address} & \bitbox{4}{IP address} \\
    \bitboxes*{1}{{\tt 01} {\tt 00} {\tt 00} {\tt 00} {\tt 02} {\tt 00}} \\
  \end{bytefield}
  \caption{Mixer keep-alive packets}
  \label{fig:mixerKeepalive}
\end{figure}

\section{CDJ Startup}

When a CDJ starts up the procedure and packets are nearly identical,
with groups of three packets sent at 300 millisecond intervals to port
50000 of the local network broadcast address. The only difference
between Figure \ref{fig:cdjInitial} and Figure \ref{fig:mixerInitial}
is the final byte, which is {\tt 0x01} for the CDJ, and was {\tt 0x02}
for the mixer.

\begin{figure}[h]
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{0a}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 25} {\tt 01}} \\
  \end{bytefield}
  \caption{Initial announcement packets from CDJ}
  \label{fig:cdjInitial}
\end{figure}

Similarly, the next series of three packets from the CDJ are nearly
identical to those from the mixer. The only difference between Figure
\ref{fig:cdjStage1} and Figure \ref{fig:mixerStage1} is byte 37
(immediately after the packet counter $N$), which again is {\tt
  0x01} for the CDJ, and was {\tt 0x02} for the mixer.

\begin{figure}
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a}
          {\tt 4f} {\tt 4c} {\tt \textbf{00}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 2c} {$N$} {\tt 01}} &
    \bitbox{6}{MAC address} \\
  \end{bytefield}
  \caption{First-stage CDJ device number assignment packets}
  \label{fig:cdjStage1}
\end{figure}

However it appears that in this capture the CDJ skips the second stage
of claiming a device number, probably because it is configured to be
automatically assigned a device number based on the port of the mixer
to which it is connected, and we cannot see a packet that the mixer
sent it assigning it that device number. Instead, it jumps right to
the end of the third and final stage, sending a single 38-byte packet
with header byte 10 set to {tt 04} (which identified the three packets
of the third stage when the mixer was starting up), with content
identical to Figure \ref{fig:mixerStage3}.

Even though the value of $N$ is {\tt 01}, this is the only packet
in this series that the CDJ sends. It would probably behave
differently if configured to assign its own device number (behaving
like we saw the mixer behave in claiming its device number).

The CDJ then moves to the keep-alive stage, sending out 54-byte
packets with the content shown in Figure \ref{fig:cdjKeepalive}.

\begin{figure}[h]
  \begin{bytefield}[bitwidth=1.5em]{16}
    \bitheader{0-15} \\
    \begin{rightwordgroup}{Name}
      \begin{leftwordgroup}{Header}
        \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
          {\tt 4c} {\tt \textbf{06}} {\tt 00}}
        & \bitbox[lrt]{4}{}
      \end{leftwordgroup} \\
      \wordbox[lrb]{1}{Device Name (padded with {\tt 00})} 
    \end{rightwordgroup} \\
    \bitboxes*{1}{{\tt 01} {\tt 02} {\tt 00} {\tt 36}} &
    \bitbox{1}{$D$} & \bitbox{1}{\tt 01} &
    \bitbox{6}{MAC address} & \bitbox{4}{IP address} \\
    \bitboxes*{1}{{\tt 01} {\tt 00} {\tt 00} {\tt 00} {\tt 01} {\tt 00}} \\
  \end{bytefield}
  \caption{CDJ keep-alive packets}
  \label{fig:cdjKeepalive}
\end{figure}

As seems to always be the case when comparing mixer and CDJ packets,
the difference between this and Figure \ref{fig:mixerKeepalive} is
that byte 37 (following the device number $D$) has the value {\tt
  01} rather than {\tt 02}, and the same is true of the second-to-last
byte in each of the packets. (Byte 52 is {\tt 01} in Figure
\ref{fig:cdjKeepalive} and {\tt 02} in Figure \ref{fig:mixerKeepalive}.

\section{Tracking BPM and Beats}

For some time now,
Afterglow\footnote{\url{https://github.com/brunchboy/afterglow\#afterglow}}
has been able to synchronize its light shows with music being played
on Pioneer equipment by observing packets broadcast by the mixer to
port 50001. Until recently, however, it was not possible to tell which
player was the Master, so there was no way to determine the down beat
(the start of each measure). This section will be expanded and more
details provided as Afterglow is updated to take advantage of the
discoveries described in the next section.

Until then, here is a summary of what is currently done. A socket is
opened and bound to port 50001. Whenever a packet from the mixer is
received on this socket, if the length is 96 bytes, it is known to
contain beat and BPM information. The current BPM can be obtained as:

\[ \frac{byte[90] \times 256 + byte[91]}{100} \]

These packets are sent on each beat, and the current beat number (1,
2, 3 or 4) is sent in $byte[92]$. However, the beat number is
\emph{not} synchronized with the master player, and so it is not
useful for much. We expect to make use of the Virtual CDJ technique to
determine the actual beat number soon.

\section{Creating a Virtual CDJ}

Although some useful information can be obtained simply by watching
broadcast traffic on a network containing Pioneer gear, in order to
get important details it is necessary to cause the gear to send you
information directly. This can be done by simulating a ``Virtual
CDJ''.\footnote{Thanks are due to Diogo Santos for discovering the
  trick of creating a virtual CDJ in order to receive detailed status
  information from other devices.}

To do this, bind a UDP server socket to port 50002 on the network
interface on which you are receiving DJ-Link traffic, and start
sending keep-alive packets to port 50000 on the broadcast address as
if you were a CDJ. Follow the structure shown in Figure
\ref{fig:cdjKeepalive}, but use the actual MAC and IP addresses of the
network interface on which you are receiving DJ-Link traffic, so the
devices can see how to reach you.

You can use a value like 5 for $D$ (the device/player number) so
as not to conflict with any actual players you have on the network,
and any name you would like. As long as you are sending these packets
roughly every 1.5 seconds, the other players and mixers will begin
sending packets directly to the socket you have opened on port 50002.

We are just beginning to analyze all the information which can be
gleaned from these packets, but here is what we know so
far.\footnote{Examples of packets discussed in this section can be
  found in the capture at
  \url{https://github.com/brunchboy/dysentery/raw/master/doc/assets/to-virtual.pcapng}}

\subsection{Mixer Status Packets}

Packets from the mixer will have a length of 56 bytes and the content
shown in Figure \ref{fig:mixerStatus}.

\begin{figure}[h]
  \begin{bytefield}[bitwidth=1.9em, leftcurly=., leftcurlyspace=0pt]{16}
    \bitheader{0-15} \\

    \begin{leftwordgroup}{\tiny 0} % 0x00
      \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
        {\tt 4c} {\tt \textbf{29}}}
      & \bitbox[lrt]{5}{}
    \end{leftwordgroup} \\
    
    \begin{leftwordgroup}{\tiny 16} % 0x10
      \bitbox[lrb]{15}{Device Name (padded with {\tt 00})} \bitbox{1}{\tt 01}
    \end{leftwordgroup} \\
    
    \begin{leftwordgroup}{\tiny 32} % 0x20
      \bitbox{1}{\tt 00} & \bitbox{1}{$D$} & \bitboxes*{1}{{\tt 00} {\tt 14}} &
      \bitbox{1}{$D$} & \bitboxes*{1}{{\tt 00} {\tt 00} {\tt d0} {\tt 00} {\tt 10} {\tt 00}
        {\tt 00} {\tt 80} {\tt 00}} & \bitbox{2}{$BPM$}
    \end{leftwordgroup} \\
    
    \begin{leftwordgroup}{\tiny 48} % 0x30
      \bitboxes*{1}{{\tt 00} {\tt 10} {\tt 00} {\tt 00} {\tt 00} {\tt 09} {\tt 00}} &
      \bitbox{1}{$X$} & \bitbox{1}{$B$} & \bitbox[]{7}{}
    \end{leftwordgroup} \\
  \end{bytefield}
  \caption{Mixer status packets}
  \label{fig:mixerStatus}
\end{figure}

Packets coming from a DJM-2000 nexus connected as the only mixer on
the network contain a value of 33 ({\tt 0x21}) for their Device Number
$D$ (bytes 33 and 36).

The current tempo in beats-per-minute identified by the mixer can be
obtained as:

\[ \frac{byte[46] \times 256 + byte[47]}{100} \]

This value is labeled $BPM$ in Figure \ref{fig:mixerStatus}.

Mixer status packets are sent on each beat, and the current beat number (1,
2, 3 or 4) is sent in $byte[55]$, labeled $B$. However, the beat number is
\emph{not} synchronized with the master player, and so it is not
useful for much. The beat number should be determined, when needed,
from packets that are sent by the master player.

The value at $byte[54]$, labeled $X$, has an unknown meaning. It
seems to start out with the value {\tt 0x00}, and then change when a
player starts playing to the value {\tt 0xff}, but it may well do
other things as well.

\subsection{CDJ Status Packets}

Packets from a CDJ will have a length of 212 bytes and the content
shown in Figure \ref{fig:cdjStatus}.

\begin{figure}
  \begin{bytefield}[bitwidth=1.9em, leftcurly=., leftcurlyspace=0pt]{16}
    \bitheader{0-15} \\

    \begin{leftwordgroup}{\tiny 0} % 0x00
      \bitboxes*{1}{{\tt 51} {\tt 73} {\tt 70} {\tt 74} {\tt 31} {\tt 57} {\tt 6d} {\tt 4a} {\tt 4f}
        {\tt 4c} {\tt \textbf{0a}}}
      & \bitbox[lrt]{5}{}
    \end{leftwordgroup} \\
    
    \begin{leftwordgroup}{\tiny 16} % 0x10
      \bitbox[lrb]{15}{Device Name (padded with {\tt 00})} \bitbox{1}{\tt 01}
    \end{leftwordgroup} \\
    
    \begin{leftwordgroup}{\tiny 32} % 0x20
      \bitbox{1}{\tt 03} & \bitbox{1}{$D$} & \bitboxes*{1}{{\tt 00} {\tt b0}} &
      \bitbox{1}{$D$} & \bitboxes*{1}{{\tt 00} {\tt 01}} & \bitbox{1}{$A$} & \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00}
        {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 48} % 0x30
      \bitboxes*{1}{{\tt 00} {\tt 00}} \bitbox{2}{$Track$} \bitboxes*{1}{{\tt 00} {\tt 00} {$t_2$} {$t_3$}
        {\tt 00} {\tt 00} {$t_4$} {$t_5$} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 64} % 0x40
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {$t_6$} {$t_7$}
        {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 80} % 0x50
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}
        {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 96} % 0x60
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}
        {\tt 01} {\tt 00} {$U_a$} {\tt 04} {\tt 00} {\tt 00} {\tt 00} {$U_l$}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 112} % 0x70
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 04} {\tt 00}} & \bitbox{1}{$U_g$} & \bitboxes*{1}{{\tt 00} {\tt 00}
        {\tt 01} {\tt 00} {\tt 00}} & \bitbox{1}{$P_1$} & \bitboxes*{1}{{\tt 31} {\tt 2e} {\tt 32} {\tt 34}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 128} % 0x80
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}} & \bitbox{2}{$Sync_n$} &
      \bitbox{1}{\tt 00} & \bitbox{1}{$F$} & \bitbox{1}{\tt ff} &
      \bitbox{1}{$P_2$} & \bitbox{1}{\tt 00} & \bitbox{3}{$Pitch_1$}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 144} % 0x90
      \bitbox{2}{$l_1$} & \bitbox{2}{$BPM$} & \bitboxes*{1}{{\tt 7f} {\tt ff} {\tt ff} {\tt ff} {\tt 00}} &
      \bitbox{3}{$Pitch_2$} & \bitbox{1}{\tt 00} & \bitbox{1}{$P_3$} & \bitbox{1}{$l_2$} & \bitbox{1}{\tt ff}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 160} % 0xa0
      \bitbox{4}{$Beat$} & \bitbox{2}{$Mem$} & \bitbox{1}{$B_b$} &
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 176} % 0xb0
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 10} {\tt 00}
        {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 192} % 0xc0
      \bitbox{1}{\tt 00} & \bitbox{3}{$Pitch_3$} & \bitbox{1}{\tt 00} & \bitbox{3}{$Pitch_4$} & 
      \bitbox{4}{$Packet$} & \bitboxes*{1}{{\tt 0f} {\tt 00} {\tt 00} {\tt 00}}
    \end{leftwordgroup} \\

    \begin{leftwordgroup}{\tiny 208} % 0xd0
      \bitboxes*{1}{{\tt 00} {\tt 00} {\tt 00} {\tt 00}} & \bitbox[]{12}{}
    \end{leftwordgroup} \\

  \end{bytefield}
  \caption{CDJ status packets}
  \label{fig:cdjStatus}
\end{figure}

The Device Number in $D$ (bytes 33 and 36) is the Player Number as
displayed on the CDJ itself. In the case of this capture, the CDJs
were assigned Player Numbers 2 and 3.

The activity flag $A$ at byte 39 seems to be 0 when the player is
idle, and 1 when it is playing, searching, or loading a track.

The track number being played (its position within a playlist or other
scrolling list of tracks, as displayed on the CDJ) can be found at
bytes 50 and 51, labeled $Track$. (It may be a 4-byte value and also
include bytes 48 and 49, but that would seem an unmanageable number of
tracks to search through.)

There are a number of bytes, labeled $t_2$ through $t_7$, whose
purpose is as yet undetermined. They are all zero when there is no
track loaded, but take different values when a track is loaded.
(Actually, there are many other bytes than these which behave like
this, so they will probably be removed from the chart in a future
version of this document.)

Byte 106, labeled $U_a$ (for ``USB activity''), alternates between the
values 4 and 6 when there is USB activity---it may even alternate in
time with the flashing USB indicator LED on the player. Byte 111
($U_l$ for ``USB local'') has the value 4 when there is no USB media
loaded, 0 when USB is loaded, and 2 when the USB Stop button has been
pressed and the USB media is being unmounted.

Byte 117, labeled $U_g$ (for ``USB global''), appears to have the
value 1 whenever USB media is present in any player on the network,
whether or not the Link option is chosen in the other players, and 0
otherwise. I don't know if that is true of other linkable SD media as
well; this needs more investigation.

Byte 123, labeled $P_1$, appears to describe the current play mode.
The values that have been seen so far, and their apparent meanings,
are:
\begin{description}
\item[0] No track is loaded.
\item[3] The player is playing normally.
\item[4] The player is playing a loop.
\item[5] The player is paused anywhere other than the cue point.
\item[6] The player is paused at the cue point.
\item[9] The player is searching forwards or backwards.
\item[17] The player reached the end of the track and stopped.
\end{description}

The value $Sync_n$ at bytes 134--135 seems to increment whenever the
player syncs to a new tempo master (another player or the mixer). I am
assuming it is just a 2-byte value, because I tried syncing 256 times
and saw the counter expand from byte 135 to include byte 134. It may
actually be a 4-byte value and also involve bytes 132 and 133, but I
wasn't going to try changing sync 65,536 times or more to find out.
Perhaps we could write software to test that someday by forcing tempo
master changes.

Byte 137, labeled $F$, is a bit field containing some very useful
state flags, detailed in Figure \ref{fig:cdjStateFlags}.

\begin{figure}[ht]
  \begin{bytefield}[endianness=big,bitwidth=4em]{8}
    \bitheader{0-7} \\
    \bitbox{1}{\tt 1} & \bitbox{1}{\small{Play}} & \bitbox{1}{\small{Master}} & \bitbox{1}{\small{Sync}}
    \bitbox{1}{\small{On-Air}} & \bitbox{1}{\tt 1} & \bitbox{1}{\tt 0} & \bitbox{1}{\tt 0} \\
  \end{bytefield}
  \caption{CDJ state flag bits}
  \label{fig:cdjStateFlags}
\end{figure}

\begin{quotation}
  We have not yet seen any other values for bits 0, 1, 2, or 7 in $F$,
  so we're unsure if they also carry meaning. If you ever find
  different values for them, please let us know by filing an Issue!
  \url{https://github.com/brunchboy/dysentery/issues}
\end{quotation}

Byte 139, labeled $P_2$ seems to be another play state indicator,
having the value 126 when stopped and 122 when playing.

There are four different places where pitch information appears in
these packets: $Pitch_1$ at bytes 141--143, $Pitch_2$ at bytes
153--155, $Pitch_3$ at bytes 193--195, and $Pitch_4$ at bytes
197--199.

Each of these values represents a three-byte pitch adjustment
percentage, where {\tt 0x100000} represents no adjustment ($0\%$),
{\tt 0x000000} represents slowing all the way to a complete stop
($-100\%$, reachable only in Wide tempo mode), and {\tt 0x200000}
represents playing at double speed ($+100\%$).

Here is how the pitch adjustment percentage represented by $Pitch_1$
would be calculated:

\begin{displaymath}
  100 \times
  \frac{(byte[141] \times 65536 + byte[142]  \times 256 + byte[143]) - 1048576}{1048576}
\end{displaymath}

We don't know why there are so many copies of the pitch information,
or all circumstances under which they might differ from each other,
but it seems that $Pitch_1$ and $Pitch_3$ report the current pitch
adjustment actually in effect (as reflected on the BPM display),
whether it is due to the local pitch fader, or a synced tempo master.

$Pitch_2$ and $Pitch_4$ are always tied to the position of the local
pitch fader, unless Tempo Reset is active, effectively locking the
pitch fader to 0\% and $Pitch_2$ and $Pitch_4$ to {\tt 0x100000}, or
the player is paused or the jog wheel is being held down, freezing
playback and locking the local pitch to $-100\%$, in which case they
both have the value {\tt 0x000000}.

When playback stops, either due to the play button being pressed or
the jog wheel held down, the value of $Pitch_4$ drops to {\tt
  0x000000} instantly, while the value of $Pitch_2$ drops over time,
reflecting the gradual slowdown of playback which is controlled by the
player's brake speed setting. When playback starts, again either due
to the play button being pressed or the jog wheel being released, both
$Pitch_2$ and $Pitch_4$ gradually rise to the target pitch, at a speed
controlled by the player's release speed setting.

If the player is \emph{not} synced, but the current pitch is different
than what the pitch fader would indicate (in other words, the player
is in the mode where it tells you to move the pitch fader to the
current BPM in order to change the pitch), moving the pitch fader
changes the values of $Pitch_2$ and $Pitch_4$ until they match
$Pitch_1$ and $Pitch_3$ and begin to affect the actual effective
pitch. From that point on, moving the pitch fader sets the value of
all of $Pitch_1$, $Pitch_2$, $Pitch_3$, and $Pitch_4$. This all seems
more complicated than it really needs to be...

The current BPM of the track (the BPM at the point that is currently
being played, or at the location where the player is currently paused)
can be found at bytes 146--147 (labeled $BPM$). It is a two-byte
integer representing one hundred times the current track BPM. So, the
current track BPM value to two decimal places can be calculated as:

\[ \frac{byte[146] \times 256 + byte[147]}{100} \]

In order to obtain the actual playing BPM (the value shown in the BPM
display), this value must be multiplied by the current effective
pitch, calculated from $Pitch_1$ as described above.

Because Rekordbox and the CDJs support tracks with variable BPM, this
value can and does change over the course of playing such tracks. When
no track is loaded, $BPM$ has the value {\tt 0xffff}.

The meaning of values $l_1$ (bytes 144--145) and $l_2$ (byte 158) are
not currently known. They may simply reflect whether a track is loaded
or not: $l_1$ seems to have the value {\tt 0x7fff} when no track is
loaded, and the value {\tt 0x8000} when a track is loaded, while $l_2$
has the value 0 when no track is loaded, 1 when a track is loaded, and
2 when a track is loaded an the player is the sync master... but there
is likely more going on here than we have yet figured out.

Byte 157 (labeled $P_3$) seems to communicate additional information
about the current play mode, with the following meanings that we have
found so far:
\begin{description}
\item[0] No track is loaded.
\item[1] The player is paused or playing in Reverse mode.
\item[9] The player is playing in Forward mode with jog mode set to Vinyl.
\item[13] The player is playing in Forward mode with jog mode set to CDJ.
\end{description}

The 4-byte beat counter (which counts each beat from 1 through the end
of the track) is found in bytes 160--163, labeled $Beat$. When the
player is paused at the start of the track, this seems to hold the
value 0, even though it is beat 1, and when no track it loaded, this
holds the value {\tt 0xffffffff}.

The counter $B_b$ at byte 166 counts out the beat within each bar,
cycling $1\to2\to3\to4$ repeatedly, and can be used to identify the
down beat (as is used in the Master Player display on the CDJs as a
mixing aid). Again, when no track is loaded, this holds the value 0.

A countdown timer to the next saved memory point is available in bytes
164--165 (labeled $Mem$). If there is no saved memory point after the
current play location in the track, or if it is further than 64 bars
ahead, these bytes contain the value {\tt 0x01ff} and the CDJ displays
``-\,-.- Bars''. As soon as there are just 64 bars (256 beats) to
go before the next memory point, this value becomes {\tt 0x0100}. This
is the point at which the CDJ starts to display a countdown, which it
displays as ``63.4 Bars''. As each beat goes by, this value decreases
by 1, until the memory point is about to be reached, at which point
the value is {\tt 0x0001} and the CDJ displays ``0.1 Bars''. On the
beat on which the memory point was saved the value is {\tt 0x0000} and
the CDJ displays ``0.0 Bars''. On the next beat, the value becomes
determined by the next memory point (if any) in the track.

Bytes 200-203 seem to contain a 4-byte packet counter $Packet$, which
is incremented for each packet sent by the player. (I am just guessing
it is four bytes long, I have not yet watched long enough for the
count to need more than the last three bytes).

\begin{quote}
  This analysis is incomplete; there are many bytes whose purpose is
  not yet known, not all of which are even mentioned here yet.
\end{quote}

\begin{center}
  \includegraphics[width=4cm]{DS-Logo-bw-4k}
\end{center}

\end{document}

